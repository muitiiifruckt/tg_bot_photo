import asyncio
import logging
import aiohttp
import io
import json
import os
from datetime import datetime
from logging.handlers import RotatingFileHandler
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, ContextTypes, filters
from config import TELEGRAM_BOT_TOKEN, RUBY_PRICE
from database import Database
from openrouter_client import OpenRouterClient
from yookassa_payment import YooKassaPayment

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –≤ —Ñ–∞–π–ª
interaction_logger = logging.getLogger('user_interactions')
interaction_logger.setLevel(logging.INFO)
# –û—Ç–∫–ª—é—á–∞–µ–º —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–π –ª–æ–≥–≥–µ—Ä
interaction_logger.propagate = False

# –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–∞–π–ª–∞ —Å —Ä–æ—Ç–∞—Ü–∏–µ–π (–º–∞–∫—Å–∏–º—É–º 10MB, –¥–æ 5 —Ñ–∞–π–ª–æ–≤)
log_dir = 'logs'
os.makedirs(log_dir, exist_ok=True)  # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç

file_handler = RotatingFileHandler(
    os.path.join(log_dir, 'user_interactions.log'),
    maxBytes=10*1024*1024,  # 10MB
    backupCount=5,
    encoding='utf-8'
)
file_handler.setLevel(logging.INFO)
file_formatter = logging.Formatter('%(asctime)s - %(message)s', datefmt='%Y-%m-%d %H:%M:%S')
file_handler.setFormatter(file_formatter)
interaction_logger.addHandler(file_handler)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
db = Database()
openrouter = OpenRouterClient()
yookassa = YooKassaPayment()


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = update.effective_user
    interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | COMMAND: /start | NAME: {user.first_name}")
    
    await db.get_or_create_user(
        user_id=user.id,
        username=user.username,
        first_name=user.first_name
    )
    
    rubies = await db.get_user_rubies(user.id)
    
    welcome_text = f"""
üëã –ü—Ä–∏–≤–µ—Ç, {user.first_name}!

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π! üé®

üíé –¢–≤–æ–∏ —Ä—É–±–∏–Ω—ã: {rubies}

–ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã:
/generate - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
/profile - –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
/buy - –ö—É–ø–∏—Ç—å —Ä—É–±–∏–Ω—ã
/feedback - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–≤–µ—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è
/help - –ü–æ–º–æ—â—å
"""
    await update.message.reply_text(welcome_text)


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    user = update.effective_user
    interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | COMMAND: /help")
    
    help_text = """
üìñ –°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É:

/generate - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –≤–∞—à–µ–º—É –æ–ø–∏—Å–∞–Ω–∏—é
/profile - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏ –±–∞–ª–∞–Ω—Å —Ä—É–±–∏–Ω–æ–≤
/buy - –ö—É–ø–∏—Ç—å —Ä—É–±–∏–Ω—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
/feedback - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–≤–µ—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –±–æ—Ç–∞
/help - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É

üíé –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–∏—Ç 2 —Ä—É–±–∏–Ω–∞
üíé 1 —Ä—É–±–∏–Ω = 5 —Ä—É–±–ª–µ–π

–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∏ –±–æ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –µ–≥–æ –¥–ª—è –≤–∞—Å!
"""
    await update.message.reply_text(help_text)


async def profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /profile"""
    user = update.effective_user
    interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | COMMAND: /profile")
    
    user_data = await db.get_or_create_user(
        user_id=user.id,
        username=user.username,
        first_name=user.first_name
    )
    
    profile_text = f"""
üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ò–º—è: {user_data['first_name']}
Username: @{user_data['username'] or '–Ω–µ —É–∫–∞–∑–∞–Ω'}
üíé –†—É–±–∏–Ω—ã: {user_data['rubies']}

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /buy –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
"""
    await update.message.reply_text(profile_text)


async def buy_rubies(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /buy - –ø–æ–∫—É–ø–∫–∞ —Ä—É–±–∏–Ω–æ–≤"""
    user = update.effective_user
    interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | COMMAND: /buy")
    
    text = f"""
üíé –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Ä—É–±–∏–Ω–æ–≤

–¶–µ–Ω–∞: 1 —Ä—É–±–∏–Ω = {int(RUBY_PRICE)} —Ä—É–±–ª–µ–π

–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–±–∏–Ω–æ–≤, –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: 10, 50, 100)

–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:
"""
    
    keyboard = [
        [InlineKeyboardButton(f"üíé 10 —Ä—É–±–∏–Ω–æ–≤ - {int(RUBY_PRICE * 10)} —Ä—É–±.", callback_data="buy_10")],
        [InlineKeyboardButton(f"üíé 50 —Ä—É–±–∏–Ω–æ–≤ - {int(RUBY_PRICE * 50)} —Ä—É–±.", callback_data="buy_50")],
        [InlineKeyboardButton(f"üíé 100 —Ä—É–±–∏–Ω–æ–≤ - {int(RUBY_PRICE * 100)} —Ä—É–±.", callback_data="buy_100")],
        [InlineKeyboardButton(f"üíé 200 —Ä—É–±–∏–Ω–æ–≤ - {int(RUBY_PRICE * 200)} —Ä—É–±.", callback_data="buy_200")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(text, reply_markup=reply_markup)
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä—É–±–∏–Ω–æ–≤
    context.user_data['waiting_for_rubies'] = True


async def buy_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ä—É–±–∏–Ω–æ–≤"""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    data = query.data
    interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | CALLBACK: {data}")
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–±–∏–Ω–æ–≤ –∏–∑ callback_data (buy_10, buy_50 –∏ —Ç.–¥.)
    try:
        rubies_count = int(data.replace("buy_", ""))
    except ValueError:
        await query.edit_message_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç")
        return
    
    if rubies_count <= 0:
        await query.edit_message_text("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–±–∏–Ω–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0")
        return
    
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É: 1 —Ä—É–±–∏–Ω = 5 —Ä—É–±–ª–µ–π
    amount = rubies_count * RUBY_PRICE
    
    # –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ –≤ –Æ–ö–∞—Å—Å–µ
    payment_info = yookassa.create_payment(
        amount=amount,
        user_id=user.id,
        rubies=rubies_count
    )
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞—Ç–µ–∂ –≤ –ë–î
    await db.create_payment(
        payment_id=payment_info["payment_id"],
        user_id=user.id,
        amount=amount,
        rubies=rubies_count
    )
    
    keyboard = [
        [InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_info["confirmation_url"])],
        [InlineKeyboardButton("‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É", callback_data=f"check_{payment_info['payment_id']}")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    text = f"""
üí≥ –°–æ–∑–¥–∞–Ω –ø–ª–∞—Ç–µ–∂

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–±–∏–Ω–æ–≤: {rubies_count} üíé
–°—É–º–º–∞: {amount:.2f} ‚ÇΩ
(1 —Ä—É–±–∏–Ω = {int(RUBY_PRICE)} —Ä—É–±–ª–µ–π)

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å" –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ —á–µ—Ä–µ–∑ –°–ë–ü.
–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É".
"""
    await query.edit_message_text(text, reply_markup=reply_markup)


async def check_payment_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø–ª–∞—Ç—ã"""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    payment_id = query.data.replace("check_", "")
    interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | CALLBACK: check_payment | PAYMENT_ID: {payment_id}")
    payment_data = await db.get_payment(payment_id)
    
    if not payment_data:
        await query.edit_message_text("‚ùå –ü–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –Æ–ö–∞—Å—Å–µ
    yookassa_status = yookassa.check_payment_status(payment_id)
    
    if yookassa_status and yookassa_status["paid"]:
        if payment_data["status"] != "succeeded":
            # –ù–∞—á–∏—Å–ª—è–µ–º —Ä—É–±–∏–Ω—ã
            await db.add_rubies(payment_data["user_id"], payment_data["rubies"])
            await db.update_payment_status(payment_id, "succeeded")
            
            rubies = await db.get_user_rubies(payment_data["user_id"])
            await query.edit_message_text(
                f"‚úÖ –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!\n\n"
                f"–ù–∞—á–∏—Å–ª–µ–Ω–æ: {payment_data['rubies']} üíé\n"
                f"–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {rubies} üíé"
            )
        else:
            await query.edit_message_text("‚úÖ –ü–ª–∞—Ç–µ–∂ —É–∂–µ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω —Ä–∞–Ω–µ–µ")
    else:
        await query.edit_message_text(
            "‚è≥ –ü–ª–∞—Ç–µ–∂ –µ—â–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–∑–∂–µ.\n\n"
            "–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É' –µ—â–µ —Ä–∞–∑."
        )


async def generate_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /generate"""
    user = update.effective_user
    interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | COMMAND: /generate")
    
    text = """
üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å.

üíé –°—Ç–æ–∏–º–æ—Å—Ç—å: 2 —Ä—É–±–∏–Ω–∞ –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é

–ü—Ä–∏–º–µ—Ä—ã:
‚Ä¢ "–ö—Ä–∞—Å–∏–≤—ã–π –∑–∞–∫–∞—Ç –Ω–∞–¥ –≥–æ—Ä–∞–º–∏"
‚Ä¢ "–ö–æ—Ç –≤ –∫–æ—Å–º–æ—Å–µ"
‚Ä¢ "–§—É—Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –≥–æ—Ä–æ–¥"
"""
    await update.message.reply_text(text)


async def save_feedback_to_jsonl(username: str, text: str, user_id: int):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–∑—ã–≤ –≤ JSONL —Ñ–∞–π–ª"""
    feedback_file = "feedback.jsonl"
    
    feedback_entry = {
        "user_id": user_id,
        "username": username or "–Ω–µ —É–∫–∞–∑–∞–Ω",
        "text": text,
        "timestamp": datetime.now().isoformat()
    }
    
    try:
        with open(feedback_file, "a", encoding="utf-8") as f:
            f.write(json.dumps(feedback_entry, ensure_ascii=False) + "\n")
        return True
    except Exception as e:
        logger.error(f"Error saving feedback: {e}")
        return False


async def feedback_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /feedback - —Å–±–æ—Ä —Å–æ–≤–µ—Ç–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è"""
    user = update.effective_user
    interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | COMMAND: /feedback")
    
    text = """
üí° –°–æ–≤–µ—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –±–æ—Ç–∞

–ú—ã —Ü–µ–Ω–∏–º –≤–∞—à–µ –º–Ω–µ–Ω–∏–µ! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à —Å–æ–≤–µ—Ç –∏–ª–∏ –ø–æ–∂–µ–ª–∞–Ω–∏–µ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –±–æ—Ç–∞.

–í–∞—à –æ—Ç–∑—ã–≤ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º —Å–¥–µ–ª–∞—Ç—å –±–æ—Ç–∞ –ª—É—á—à–µ! üôè
"""
    await update.message.reply_text(text)
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞ –æ—Ç–∑—ã–≤–∞
    context.user_data['waiting_for_feedback'] = True


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –ø–æ–∫—É–ø–∫–∏ —Ä—É–±–∏–Ω–æ–≤"""
    user = update.effective_user
    text = update.message.text
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –≤–≤–æ–¥ –æ—Ç–∑—ã–≤–∞
    if context.user_data.get('waiting_for_feedback'):
        context.user_data['waiting_for_feedback'] = False
        
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–∑—ã–≤
        interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | FEEDBACK: {text[:100]}...")
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤ –≤ JSONL —Ñ–∞–π–ª
        success = await save_feedback_to_jsonl(
            username=user.username,
            text=text,
            user_id=user.id
        )
        
        if success:
            await update.message.reply_text(
                "‚úÖ –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤! –ú—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É—á—Ç–µ–º –≤–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è. üôè"
            )
        else:
            await update.message.reply_text(
                "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–∂–∏–¥–∞–µ–º –ª–∏ –º—ã –≤–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä—É–±–∏–Ω–æ–≤
    if context.user_data.get('waiting_for_rubies'):
        context.user_data['waiting_for_rubies'] = False
        
        # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–±–∏–Ω–æ–≤
        try:
            rubies_count = int(text.strip())
            
            if rubies_count <= 0:
                await update.message.reply_text("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–±–∏–Ω–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ 0")
                return
            
            if rubies_count > 10000:
                await update.message.reply_text("‚ùå –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–±–∏–Ω–æ–≤ –∑–∞ —Ä–∞–∑: 10000")
                return
            
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É: 1 —Ä—É–±–∏–Ω = 5 —Ä—É–±–ª–µ–π
            amount = rubies_count * RUBY_PRICE
            
            # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–∫—É–ø–∫—É —Ä—É–±–∏–Ω–æ–≤
            interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | ACTION: buy_rubies | COUNT: {rubies_count} | AMOUNT: {amount:.2f} —Ä—É–±.")
            
            # –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ –≤ –Æ–ö–∞—Å—Å–µ
            payment_info = yookassa.create_payment(
                amount=amount,
                user_id=user.id,
                rubies=rubies_count
            )
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞—Ç–µ–∂ –≤ –ë–î
            await db.create_payment(
                payment_id=payment_info["payment_id"],
                user_id=user.id,
                amount=amount,
                rubies=rubies_count
            )
            
            keyboard = [
                [InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_info["confirmation_url"])],
                [InlineKeyboardButton("‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É", callback_data=f"check_{payment_info['payment_id']}")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            payment_text = f"""
üí≥ –°–æ–∑–¥–∞–Ω –ø–ª–∞—Ç–µ–∂

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–±–∏–Ω–æ–≤: {rubies_count} üíé
–°—É–º–º–∞: {amount:.2f} ‚ÇΩ
(1 —Ä—É–±–∏–Ω = {int(RUBY_PRICE)} —Ä—É–±–ª–µ–π)

–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å" –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ —á–µ—Ä–µ–∑ –°–ë–ü.
–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É".
"""
            await update.message.reply_text(payment_text, reply_markup=reply_markup)
            return
            
        except ValueError:
            # –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω –Ω–µ —á–∏—Å–ª–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –ø—Ä–æ–º–ø—Ç
            context.user_data['waiting_for_rubies'] = False
            # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–∞–∫ –æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –Ω–∏–∂–µ –∫–∞–∫ –ø—Ä–æ–º–ø—Ç)
            pass
    
    # –ï—Å–ª–∏ –Ω–µ –æ–∂–∏–¥–∞–µ–º –≤–≤–æ–¥ —Ä—É–±–∏–Ω–æ–≤, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    prompt = text
    
    # –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | ACTION: generate_image | PROMPT: {text[:100]}...")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–æ–∏—Ç 2 —Ä—É–±–∏–Ω–∞)
    rubies = await db.get_user_rubies(user.id)
    GENERATION_COST = 2  # 2 —Ä—É–±–∏–Ω–∞ –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
    
    if rubies < GENERATION_COST:
        interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | ACTION: generate_image | STATUS: insufficient_balance | RUBIES: {rubies}")
        await update.message.reply_text(
            f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä—É–±–∏–Ω–æ–≤!\n\n"
            f"–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: {rubies} üíé\n"
            f"–¢—Ä–µ–±—É–µ—Ç—Å—è: {GENERATION_COST} üíé\n\n"
            f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /buy –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞."
        )
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    status_message = await update.message.reply_text("‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.")
    
    try:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        image_url = await openrouter.generate_image(prompt)
        
        if not image_url:
            await status_message.edit_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
            return
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        image_data = None
        
        if image_url.startswith("data:image"):
            # –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            image_data = openrouter.decode_base64_image(image_url)
        elif image_url.startswith("http"):
            # –ï—Å–ª–∏ —ç—Ç–æ URL, –ø—ã—Ç–∞–µ–º—Å—è —Å–∫–∞—á–∞—Ç—å
            try:
                async with aiohttp.ClientSession() as session:
                    async with session.get(image_url) as resp:
                        if resp.status == 200:
                            image_data = await resp.read()
            except Exception as e:
                logger.error(f"Error downloading image: {e}")
        
        if image_data:
            # –°–ø–∏—Å—ã–≤–∞–µ–º —Ä—É–±–∏–Ω—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π (2 —Ä—É–±–∏–Ω–∞ –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é)
            GENERATION_COST = 2
            success = await db.deduct_rubies(user.id, GENERATION_COST)
            
            if success:
                # –õ–æ–≥–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
                await db.log_generation(user.id, prompt, GENERATION_COST)
                interaction_logger.info(f"USER: @{user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'} (ID: {user.id}) | ACTION: image_generated | COST: {GENERATION_COST} rubies | SUCCESS")
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                await status_message.delete()
                await update.message.reply_photo(
                    photo=io.BytesIO(image_data),
                    caption=f"üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É: {prompt}\n\nüíé –ü–æ—Ç—Ä–∞—á–µ–Ω–æ: {GENERATION_COST} —Ä—É–±–∏–Ω–∞"
                )
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å
                new_rubies = await db.get_user_rubies(user.id)
                await update.message.reply_text(f"üíé –û—Å—Ç–∞—Ç–æ–∫ —Ä—É–±–∏–Ω–æ–≤: {new_rubies}")
            else:
                await status_message.edit_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–∏–∏ —Ä—É–±–∏–Ω–æ–≤")
        else:
            await status_message.edit_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
            
    except Exception as e:
        logger.error(f"Error in handle_message: {e}")
        await status_message.edit_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")


async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.error(f"Update {update} caused error {context.error}")


async def post_init(application: Application) -> None:
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    await db.init_db()
    logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–æ–≤
    if not TELEGRAM_BOT_TOKEN:
        logger.error("TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        return
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).post_init(post_init).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("profile", profile))
    application.add_handler(CommandHandler("buy", buy_rubies))
    application.add_handler(CommandHandler("generate", generate_command))
    application.add_handler(CommandHandler("feedback", feedback_command))
    application.add_handler(CallbackQueryHandler(buy_callback, pattern="^buy_"))
    application.add_handler(CallbackQueryHandler(check_payment_callback, pattern="^check_"))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    application.add_error_handler(error_handler)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    application.run_polling(allowed_updates=Update.ALL_TYPES)


if __name__ == "__main__":
    main()
